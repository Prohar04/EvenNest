# Complete Django + Vercel + Aiven Setup Reference

This document contains all the complete file contents for your production-ready setup.

---

## 1. myproject/settings.py

**Location:** `D:\EvenNest\Main\myproject\settings.py`

```python
"""
Django settings for myproject project.

Generated by 'django-admin startproject' using Django 5.2.

Environment strategy:
- Local dev: Uses SQLite (db.sqlite3), DEBUG=True by default
- Production (Vercel): Uses Aiven MySQL via DATABASE_URL, PyMySQL driver, DEBUG=False
"""

from pathlib import Path
import os
import dj_database_url

# Load environment variables from .env files
try:
    from dotenv import load_dotenv
    load_dotenv()
except ImportError:
    pass

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# ==============================================================================
# CORE SETTINGS
# ==============================================================================

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.getenv(
    'DJANGO_SECRET_KEY',
    'django-insecure-change-this-in-production-use-env-var'
)

# SECURITY WARNING: don't run with debug turned on in production!
# Default to False in production, True in local development
DEBUG = os.getenv('DJANGO_DEBUG', 'True').lower() in ('true', '1', 'yes')

# Determine if we're running in production (on Vercel or with DATABASE_URL)
IS_PRODUCTION = not DEBUG or bool(os.getenv('DATABASE_URL'))

# Configure ALLOWED_HOSTS for local and production
ALLOWED_HOSTS = [
    'localhost',
    '127.0.0.1',
    '.vercel.app',
]

# Add Vercel deployment URL if set
vercel_url = os.getenv('VERCEL_URL')
if vercel_url and vercel_url not in ALLOWED_HOSTS:
    ALLOWED_HOSTS.append(vercel_url)

# Add custom domain if set
custom_domain = os.getenv('CUSTOM_DOMAIN')
if custom_domain and custom_domain not in ALLOWED_HOSTS:
    ALLOWED_HOSTS.append(custom_domain)


# ==============================================================================
# APPLICATION DEFINITION
# ==============================================================================

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'channels',
    'crispy_forms',
    'crispy_bootstrap5',
    'core',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    # Whitenoise for static files (important for Vercel)
    'whitenoise.middleware.WhiteNoiseMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'myproject.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'core' / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'core.views.service_categories_processor',
                'core.views.store_categories_processor',
                'core.views.cart_processor',
            ],
        },
    },
]

WSGI_APPLICATION = 'myproject.wsgi.application'
ASGI_APPLICATION = 'myproject.asgi.application'

# Crispy forms bootstrap version
CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap5"
CRISPY_TEMPLATE_PACK = "bootstrap5"


# ==============================================================================
# DATABASE CONFIGURATION
# ==============================================================================

DATABASE_URL = os.getenv('DATABASE_URL')

if DATABASE_URL:
    # Production: Use Aiven MySQL with PyMySQL driver
    db_config = dj_database_url.parse(DATABASE_URL, conn_max_age=600)
    
    # Force MySQL backend with PyMySQL driver
    db_config['ENGINE'] = 'django.db.backends.mysql'
    
    # Handle SSL for Aiven MySQL
    # Aiven requires SSL. If DATABASE_URL contains ssl-mode=REQUIRED,
    # we need to remove it because PyMySQL doesn't accept that parameter.
    # Instead, we configure SSL via OPTIONS.
    options = db_config.get('OPTIONS', {})
    options.pop('ssl-mode', None)  # Remove Aiven's ssl-mode parameter
    
    # Configure PyMySQL SSL settings for Aiven
    # PyMySQL expects ssl as a dict with ca, cert, key, etc.
    # For Aiven, we typically just need to enable SSL.
    if 'ssl' not in options:
        options['ssl'] = {'ca': None}  # Let system use default CA bundle
    
    db_config['OPTIONS'] = options
    DATABASES = {'default': db_config}
else:
    # Local development: Use SQLite (no internet/Aiven required)
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.sqlite3',
            'NAME': BASE_DIR / 'db.sqlite3',
        }
    }


# ==============================================================================
# CHANNELS CONFIGURATION
# ==============================================================================

# Use in-memory channel layer (sufficient for Vercel without Redis)
CHANNEL_LAYERS = {
    'default': {
        'BACKEND': 'channels.layers.InMemoryChannelLayer'
    }
}

# WebSocket configuration
WEBSOCKET_ACCEPT_TIME = 20
WEBSOCKET_TIMEOUT = 3600


# ==============================================================================
# SESSIONS AND SECURITY
# ==============================================================================

SESSION_ENGINE = 'django.contrib.sessions.backends.db'
SESSION_COOKIE_AGE = 86400 * 7  # 7 days
SESSION_SAVE_EVERY_REQUEST = False
SESSION_EXPIRE_AT_BROWSER_CLOSE = False

# Default: insecure for local development
SESSION_COOKIE_SECURE = False
CSRF_COOKIE_SECURE = False
SECURE_SSL_REDIRECT = False

# Production security settings (applied when DEBUG=False)
if not DEBUG:
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True
    SECURE_SSL_REDIRECT = True
    SECURE_HSTS_SECONDS = 31536000  # 1 year
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_PRELOAD = True
    # Prevent content sniffing
    SECURE_CONTENT_SECURITY_POLICY = {
        'default-src': ("'self'",),
    }


# ==============================================================================
# PASSWORD VALIDATION
# ==============================================================================

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# ==============================================================================
# INTERNATIONALIZATION
# ==============================================================================

LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'UTC'
USE_I18N = True
USE_TZ = True


# ==============================================================================
# STATIC FILES
# ==============================================================================

STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'

# Whitenoise storage for efficient static file serving on Vercel
if IS_PRODUCTION:
    STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'
else:
    STATICFILES_STORAGE = 'django.contrib.staticfiles.storage.ManifestStaticFilesStorage'


# ==============================================================================
# MEDIA FILES
# ==============================================================================

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'


# ==============================================================================
# DEFAULT PRIMARY KEY FIELD TYPE
# ==============================================================================

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'


# ==============================================================================
# MESSAGE TAGS FOR BOOTSTRAP
# ==============================================================================

from django.contrib.messages import constants as messages

MESSAGE_TAGS = {
    messages.DEBUG: 'alert-info',
    messages.INFO: 'alert-info',
    messages.SUCCESS: 'alert-success',
    messages.WARNING: 'alert-warning',
    messages.ERROR: 'alert-danger',
}


# ==============================================================================
# AUTHENTICATION AND REDIRECTS
# ==============================================================================

LOGIN_REDIRECT_URL = 'home'
LOGIN_URL = 'login'
LOGOUT_REDIRECT_URL = 'login'


# ==============================================================================
# CACHING
# ==============================================================================

# Use local memory cache for development, database cache for production
if IS_PRODUCTION:
    CACHES = {
        'default': {
            'BACKEND': 'django.core.cache.backends.db.DatabaseCache',
            'LOCATION': 'django_cache_table',
        }
    }
else:
    CACHES = {
        'default': {
            'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
            'LOCATION': 'unique-snowflake',
        }
    }
```

---

## 2. requirements.txt

**Location:** `D:\EvenNest\Main\requirements.txt`

```
Django==5.2rc1
channels==4.2.2
daphne==4.1.2
aioredis==1.3.1
redis==6.0.0
django-crispy-forms==2.4
crispy-bootstrap5==2.0.2
Pillow==11.2.1
PyMySQL==1.1.2
dj-database-url==3.0.1
whitenoise==6.7.0
python-dotenv==1.0.0
```

---

## 3. myproject/__init__.py

**Location:** `D:\EvenNest\Main\myproject\__init__.py`

```python
"""
Django project initialization.

This module configures PyMySQL as the default MySQL driver for Django.
This allows Django to use PyMySQL instead of MySQLdb, which is more
compatible with Vercel and doesn't require C extensions to be compiled.
"""

import pymysql

# Install PyMySQL as the MySQLdb implementation for Django
# This must happen before any Django imports that use the database
pymysql.install_as_MySQLdb()
```

---

## 4. vercel.json

**Location:** `D:\EvenNest\Main\vercel.json`

```json
{
  "buildCommand": "pip install -r requirements.txt && python manage.py collectstatic --noinput --clear",
  "installCommand": "pip install -r requirements.txt",
  "framework": "django",
  "python": {
    "version": "3.11"
  },
  "env": {
    "PYTHONUNBUFFERED": "1"
  },
  "functions": {
    "myproject/wsgi.py": {
      "memory": 3008,
      "maxDuration": 30
    }
  },
  "routes": [
    {
      "src": "/static/(.*)",
      "dest": "/staticfiles/$1",
      "headers": {
        "Cache-Control": "public, max-age=31536000, immutable"
      }
    },
    {
      "src": "/(.*)",
      "dest": "myproject/wsgi.py"
    }
  ]
}
```

---

## 5. .env.local (for local development)

**Location:** `D:\EvenNest\Main\.env.local`

```
# ==============================================================================
# LOCAL DEVELOPMENT ENVIRONMENT
# ==============================================================================
# This file is used for local development with SQLite.
# DO NOT commit this file to version control; add it to .gitignore
# Copy this file to .env and adjust values as needed.

# Django Settings
DJANGO_DEBUG=True
DJANGO_SECRET_KEY=your-local-dev-secret-key-change-this-in-production

# Database
# Leave DATABASE_URL unset to use SQLite (db.sqlite3)
# DATABASE_URL is NOT set in local dev
# Uncomment the line below only if you want to test against Aiven locally:
# DATABASE_URL=mysql://avnadmin:YOUR_PASSWORD@mysql-XXXXX.c.aivencloud.com:13270/defaultdb

# Optional: If you have Redis running locally for caching
# REDIS_URL=redis://localhost:6379/0

# Vercel (not needed for local dev)
# VERCEL_URL is automatically set by Vercel during deployment
```

---

## 6. .env.production (for Vercel)

**Location:** `D:\EvenNest\Main\.env.production`

```
# ==============================================================================
# PRODUCTION ENVIRONMENT (VERCEL)
# ==============================================================================
# This file documents the environment variables needed in Vercel.
# DO NOT commit real credentials to this file.
# Set these values in the Vercel dashboard under Project Settings > Environment Variables

# Django Settings
DJANGO_DEBUG=False
DJANGO_SECRET_KEY=use-a-strong-random-key-generate-with-django-shell-or-secrets-token_urlsafe-32

# Database - Aiven MySQL
# Format: mysql+pymysql://user:password@host:port/database
# NOTE: Remove ssl-mode=REQUIRED from the URL; Django will handle SSL via OPTIONS in settings.py
DATABASE_URL=mysql://avnadmin:YOUR_AIVEN_PASSWORD@mysql-XXXXX-XXXXX.c.aivencloud.com:13270/defaultdb

# Optional: Custom Domain (if you have one)
# CUSTOM_DOMAIN=yourdomain.com

# Vercel will automatically set VERCEL_URL during deployment
```

---

## 7. Database URL Format Guide

### How to Format Your Aiven MySQL URL for Django

**Aiven provides this format:**
```
mysql://avnadmin:MY_PASSWORD@mysql-3d02263f-proharsaha04-033f.c.aivencloud.com:13270/defaultdb?ssl-mode=REQUIRED
```

**Django expects this format (remove `ssl-mode=REQUIRED`):**
```
mysql://avnadmin:MY_PASSWORD@mysql-3d02263f-proharsaha04-033f.c.aivencloud.com:13270/defaultdb
```

**Why?** PyMySQL doesn't recognize `ssl-mode` as a parameter. Django's `settings.py` handles SSL configuration automatically via the `OPTIONS` dict.

### Setting DATABASE_URL as Environment Variable

**Local (PowerShell):**
```powershell
# Temporarily set for current session only
$env:DATABASE_URL = 'mysql://avnadmin:YOUR_PASSWORD@mysql-XXXXX.c.aivencloud.com:13270/defaultdb'

# Verify it's set
echo $env:DATABASE_URL

# Use it
python manage.py migrate

# Clear it when done
Remove-Item env:DATABASE_URL
```

**Vercel Dashboard:**
1. Go to Vercel Dashboard → Select Project
2. Go to Settings → Environment Variables
3. Add new variable:
   - **Name:** `DATABASE_URL`
   - **Value:** `mysql://avnadmin:YOUR_PASSWORD@mysql-XXXXX.c.aivencloud.com:13270/defaultdb`
   - **Environments:** Production, Preview, Development (select all)
4. Click "Save"

---

## 8. Quick Start Commands Summary

### Local Development (SQLite)

```powershell
# Navigate to project
cd D:\EvenNest\Main

# Create and activate virtual environment
python -m venv venv
.\venv\Scripts\Activate.ps1

# Install dependencies
pip install -r requirements.txt

# Copy .env.local to .env
Copy-Item .env.local .env

# Run migrations (uses SQLite)
python manage.py migrate

# Create superuser
python manage.py createsuperuser

# Start dev server
python manage.py runserver

# Visit http://localhost:8000/
```

### Testing with Aiven (Production Database)

```powershell
# Set DATABASE_URL to point to Aiven
$env:DATABASE_URL = 'mysql://avnadmin:YOUR_PASSWORD@mysql-XXXXX.c.aivencloud.com:13270/defaultdb'

# Test connection
python manage.py dbshell

# Run migrations on Aiven
python manage.py migrate

# Unset DATABASE_URL when done
Remove-Item env:DATABASE_URL
```

### Deploy to Vercel

```powershell
# Ensure everything is committed
git add -A
git commit -m "Ready for Vercel deployment"
git push origin main

# Install Vercel CLI (one time)
npm install -g vercel

# Deploy to production
vercel --prod

# View logs
vercel logs --tail
```

---

## 9. Assumptions and Notes

### Assumptions Made:

1. **Python 3.11+** is being used locally and on Vercel
2. **Project structure** follows standard Django layout (myproject is the main module)
3. **Your Aiven instance** is accessible and MySQL tables don't exist yet (migrations will create them)
4. **You have git** configured and your code is in a GitHub/GitLab/Bitbucket repo
5. **You're not using Redis** in production (using in-memory channels layer instead)
6. **You don't need django-storages for S3** (static files served by Whitenoise)
7. **Your custom middleware** in `core/middleware.py` exists; if not, remove the reference

### What Changed:

| Item | Before | After | Reason |
|------|--------|-------|--------|
| MySQL driver | mysqlclient (fails on Vercel) | PyMySQL (pure Python) | No C extensions needed |
| SSL handling | `ssl-mode=REQUIRED` in URL | Removed from URL, configured in OPTIONS | PyMySQL doesn't accept `ssl-mode` |
| Static files | Django dev server + ManifestStorage | Whitenoise + CompressedManifestStorage | Vercel needs efficient static serving |
| DEBUG in local | Checking env var as string | Checking env var with `.lower()` | More robust boolean conversion |
| Installed apps | channels_redis, django-storages | crispy-bootstrap5, whitenoise | Better for Vercel + cleaner dependencies |
| Channels layer | Not specified | InMemoryChannelLayer | Production-safe without external Redis |

---

## 10. Known Gotchas and Best Practices

### ⚠️ Don't Do This:

- ❌ Commit `.env` files to git
- ❌ Use SQLite on Vercel (ephemeral filesystem)
- ❌ Use mysqlclient on Vercel (needs gcc)
- ❌ Keep `ssl-mode=REQUIRED` in Django DATABASE_URL
- ❌ Set `DJANGO_SECRET_KEY` to a weak/predictable value
- ❌ Run migrations directly on Vercel (use local terminal with DATABASE_URL)
- ❌ Mix SQLite and MySQL (use one or the other per environment)

### ✅ Do This Instead:

- ✅ Use `.env.local` for local dev, `.env.production` for reference only
- ✅ Add `.env*` to `.gitignore`
- ✅ Use a strong DJANGO_SECRET_KEY (run: `python -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"`)
- ✅ Test migrations locally against Aiven before deploying
- ✅ Always set `DJANGO_DEBUG=False` on Vercel
- ✅ Monitor Vercel logs after deployment: `vercel logs --tail`
- ✅ Create superuser on Aiven for production (separate from local SQLite user)

---

## 11. Verification Checklist

Use this before and after deployment:

### Pre-Deployment (Local)

- [ ] `.env` exists and DATABASE_URL is not set
- [ ] `python manage.py migrate` succeeds
- [ ] `python manage.py createsuperuser` succeeds
- [ ] `python manage.py runserver` works
- [ ] Admin page loads at `http://localhost:8000/admin/`
- [ ] CSS/static files load (not plain HTML)
- [ ] Can log in with superuser

### Migration Testing (Aiven)

- [ ] `DATABASE_URL` set correctly in PowerShell
- [ ] `python manage.py dbshell` connects
- [ ] `python manage.py migrate` applies migrations to Aiven
- [ ] Tables visible in Aiven SQL editor: `SHOW TABLES;`
- [ ] No SSL or connection errors

### Post-Deploy (Vercel)

- [ ] `vercel --prod` completed successfully
- [ ] Deployment URL is accessible (e.g., `https://evennest.vercel.app/`)
- [ ] Admin login works
- [ ] Home page loads without 500 errors
- [ ] CSS/static files load properly
- [ ] `vercel logs` shows no critical errors
- [ ] Database operations work (can view items in admin)

---

End of Reference Guide
